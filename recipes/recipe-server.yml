---
# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json
name: vedaos-server
description: This is my personal OS image.
base-image: quay.io/centos-bootc/centos-bootc
image-version: c10s

modules:
  - type: dnf
    install:
      packages:
        - epel-release

  - type: dnf
    repos:
      cleanup: true
      files:
        - https://pkgs.tailscale.com/stable/centos/10/tailscale.repo
      copr: 
        - ublue-os/packages
    install:
      install-weak-deps: false
      packages:
        - repo: epel
          packages:
            - just
        - cockpit-machines
        - cockpit-networkmanager
        - cockpit-podman
        - cockpit-selinux
        - cockpit-storaged
        - cockpit-system
        - firewalld
        - git-core
        - libvirt-client
        - libvirt-daemon
        - libvirt-daemon-kvm
        - NetworkManager-wifi
        - open-vm-tools
        - pcp-zeroconf
        - qemu-guest-agent
        - rsync
        - systemd-resolved
        - udisks2-lvm2
        - virt-install
        - xdg-user-dirs
        - tailscale
        - ublue-os-libvirt-workarounds
    remove:
      packages:
        - adcli
        - libdnf-plugin-subscription-manager
        - python3-subscription-manager-rhsm
        - subscription-manager
        - subscription-manager-rhsm-certificates
        - toolbox
        - yggdrasil
        - epel-release

  - type: files
    files:
      - source: system_files/server
        destination: /

  - type: script
    scripts:
      - resolved.sh
    snippets:
      - "sed -i 's|^ExecStart=.*|ExecStart=/usr/bin/bootc update --quiet|' /usr/lib/systemd/system/bootc-fetch-apply-updates.service"
      - "sed -i 's|^OnUnitInactiveSec=.*|OnUnitInactiveSec=7d\nPersistent=true|' /usr/lib/systemd/system/bootc-fetch-apply-updates.timer"
      - "sed -i 's|#AutomaticUpdatePolicy.*|AutomaticUpdatePolicy=stage|' /etc/rpm-ostreed.conf"
      - "sed -i 's|#LockLayering.*|LockLayering=true|' /etc/rpm-ostreed.conf"

  - type: systemd
    system:
      enabled:
        - sshd
        - firewalld
        - podman-auto-update.timer
        - tailscaled
    user:
      enabled:
        - podman-auto-update.timer

  - type: initramfs

  - type: signing
